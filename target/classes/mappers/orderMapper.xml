<?xml version="1.0" encoding="UTF-8"?>

<!-- DTD 선언 -->
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org/DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="orderMapper">
	<select id="cartToOrderList" resultType="com.lee.myapp.domain.OrderListVO">
		 SELECT B.CARTNO, A.PNO, B.ONO, B.MNO, A.BRAND, A.PNAME, A.PRICE, A.PRODUCT_THUMURL, B.OPTIONCOLOR, B.OPTIONSIZE, B.INVENTORY, A.SHIPPING_FEE
		  FROM PRODUCT A INNER JOIN TBL_CART B ON A.PNO = B.PNO
		 WHERE B.MNO = #{mno}
		   AND B.ONO IN
		 <foreach collection="ono" item="ono" open="(" separator="," close=")">
		 	#{ono}
		 </foreach>
 		 ORDER BY A.PNO DESC
	</select>
	
	<select id="productToOrderList" resultType="com.lee.myapp.domain.OrderListVO">
		SELECT A.PNO, B.ONO, A.BRAND, A.PNAME, A.PRICE, A.PRODUCT_THUMURL, B.OPTION_COLOR, B.OPTION_SIZE, #{inventory} AS INVENTORY, A.SHIPPING_FEE
		  FROM PRODUCT A INNER JOIN TBL_PRODUCT_OPTION B ON A.PNO = B.PNO
		 WHERE B.ONO = #{ono}
	</select>

	<insert id="orderInfo">
		INSERT INTO TBL_ORDER(ORDERNO,MNO,ORDER_REC,ZIPCODE,RECEIVED_AT,RECEIVED_AT_DETAIL,RECEIVED_PHONE,DELIVERY_MESSAGE,PAYER_NAME,PAYER_EMAIL,PAYER_PHONE,AMOUNT)
		VALUES(#{orderno},#{mno},#{orderrec},#{zipcode},#{receivedat},#{receivedatdetail},#{receivedphone},#{deliverymessage},#{payername},#{payeremail},#{payerphone},#{amount})
	</insert>
	
	<insert id="orderInfo_detail">
		INSERT INTO TBL_ORDER_DETAIL(ORDERDETAILNO, ORDERNO, PNO, OPTIONCOLOR, OPTIONSIZE, INVENTORY)
		SELECT TBL_ORDER_DETAIL_SEQ.NEXTVAL, #{orderno}, PNO, OPTIONCOLOR, OPTIONSIZE, INVENTORY
		  FROM TBL_CART
		 WHERE CARTNO IN
		 <foreach item="cartno" collection="cartno" open="(" separator="," close=")">
		 	#{cartno}
		 </foreach>
	</insert>
	
	<!-- Delete cart when order completes successfully -->
	<delete id="cartDelete">
		DELETE
		  FROM TBL_CART
		 WHERE MNO = #{mno}
		   AND CARTNO IN
		  <foreach collection="cartno" item="cartno" open="(" separator="," close=")">
		 	#{cartno}
		 </foreach>
	</delete>
	
</mapper>