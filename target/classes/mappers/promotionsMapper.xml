<?xml version="1.0" encoding="UTF-8"?>

<!-- DTD 선언 -->
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org/DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	
<mapper namespace="promotionsMapper">
	<!-- Header banner -->
	<select id="mainBannerList" resultType="com.lee.myapp.domain.BannerVO">
		SELECT *
		  FROM TBl_BANNER
		 WHERE BANNER_STATUS = 1
		   AND AREA = #{area}
		 ORDER BY BNO DESC
	</select>
	
	<select id="promotionList" resultType="com.lee.myapp.domain.PromotionsVO">
		SELECT *
		  FROM TBL_PROMOTIONS
		 ORDER BY PNO DESC
	</select>
	
	<insert id="promotionRegist">
		INSERT INTO TBL_PROMOTIONS(PNO, SUBJECT, THUMBNAIL_URL, IMAGES_URL, STARTDATE, ENDDATE)
		VALUES(TBL_PROMOTIONS_PNO_SEQ.NEXTVAL,#{subject},#{thumbnailurl},#{imagesurl},#{startdate},#{enddate})
	</insert>
	
	<!-- End of promotion if promotion period is over -->
	<update id="endPromotion">
		<![CDATA[
			UPDATE TBL_PROMOTIONS
			   SET STATUS = 0
			 WHERE PNO IN (
			    SELECT PNO
			      FROM TBL_PROMOTIONS
			     WHERE ENDDATE < TO_CHAR(SYSDATE,'YYYY-MM-DD') 
			       AND STATUS = 1
			)
		]]>
	</update>
	
	<select id="promotionView" resultType="com.lee.myapp.domain.PromotionsVO">
		SELECT *
		  FROM TBL_PROMOTIONS
		 WHERE PNO = #{pno}
	</select>
	
	<!-- Reply -->
	<insert id="commentRegist">
		INSERT INTO TBL_PROMOTIONS_COMMENT(RNO,PNO,MNO,CONTENT,REPLY_TIME)
		VALUES(TBL_PROMOTIONS_REPLY_SEQ.NEXTVAL,#{pno},#{mno},#{content},SYSDATE)
	</insert>
	
	<select id="commentList" resultType="com.lee.myapp.domain.PromotionsCommentVO">
		SELECT B.RNO,B.PNO,A.MNO,A.NAME,B.CONTENT,TO_CHAR(B.REPLY_TIME,'YYYY-MM-DD HH24:MI:SS') AS REPLY_TIME
		  FROM MEMBER A INNER JOIN TBL_PROMOTIONS_COMMENT B ON A.MNO = B.MNO
		 ORDER BY B.REPLY_TIME DESC
	</select>
</mapper>