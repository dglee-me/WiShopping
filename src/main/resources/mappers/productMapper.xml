<?xml version="1.0" encoding="UTF-8"?>

<!-- DTD 선언 -->
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org/DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	
<mapper namespace="productMapper">
	<!-- Category Register -->
	<insert id="register">
		INSERT ALL
		INTO PRODUCT(PNO,CATEGORY1,CATEGORY2,PNAME,BRAND,PRICE,PRODUCT_URL,PRODUCT_THUMURL,SHIPPING_FEE,SHIPPING_DAY) 
			VALUES(pno_seq.nextval,#{category1},#{category2},#{pname},(SELECT BRAND FROM TBL_SELLER WHERE MNO = #{mno}),#{price},#{producturl},#{productthumurl},#{shippingfee},#{shippingday})
		INTO TBL_SALES_VOLUME VALUES(TBL_SALES_VOLUME_SEQ.NEXTVAL,PNO_SEQ.CURRVAL,0)
		SELECT * FROM DUAL
	</insert>
	
	<insert id="register_option">
		INSERT INTO TBL_PRODUCT_OPTION(ONO,PNO,OPTION_COLOR,OPTION_SIZE,INVENTORY)
			VALUES(ono_seq.nextval,pno_seq.currval,#{optioncolor},#{optionsize},#{inventory})
	</insert>
	
	<!-- Cateogry list -->
	<select id="list" resultType="com.lee.myapp.domain.ProductVO">
		SELECT *
		  FROM PRODUCT
		 <if test='category2 != "all"'>
			 WHERE CATEGORY1=#{category1} AND CATEGORY2=#{category2}
		 </if>
		 <if test='category2 == "all"'>
		 	 WHERE CATEGORY1=#{category1}
		 </if>
		 ORDER BY PNO DESC
	</select>
	
	<select id="view" resultType="com.lee.myapp.domain.ProductVO">
		SELECT PNO, CATEGORY1, CATEGORY2, PNAME, BRAND, PRICE, PRODUCT_THUMURL, PRODUCT_URL, SHIPPING_FEE, SHIPPING_DAY
		  FROM PRODUCT
		 WHERE PNO = #{pno}
	</select>
	
	<select id="view_option" resultType="com.lee.myapp.domain.ProductOptionVO">
		SELECT ONO, ROW_NUMBER() OVER(ORDER BY ONO ASC) AS SEQUENCE, PNO, OPTION_COLOR, OPTION_SIZE, INVENTORY
		  FROM TBL_PRODUCT_OPTION
		 WHERE PNO = #{pno}
		 ORDER BY ONO ASC
	</select>
	
	<select id="checkInventory" resultType="int">
		SELECT INVENTORY 
		  FROM TBL_PRODUCT_OPTION
		 WHERE ONO = #{ono}
	</select>
	
	<select id="isSeller" resultType="Integer">
		SELECT COUNT(SNO) 
		  FROM TBL_SELLER
		 WHERE MNO = (SELECT MNO FROM MEMBER WHERE MNO = #{mno})
	</select>
	
	<insert id="reviewRegist">
		INSERT INTO TBL_PRODUCT_REVIEW(RNO,PNO,MNO,ONO,OPTION_COLOR,OPTION_SIZE,CONTENT,WRITEDATE,CONTENT_IMG)
		VALUES(
			TBL_PRODUCT_REVIEW_RNO_SEQ.NEXTVAL, 
			#{pno}, 
			#{mno},
			#{ono},
			(SELECT OPTION_COLOR FROM TBL_PRODUCT_OPTION WHERE ONO = #{ono}),
			(SELECT OPTION_SIZE FROM TBL_PRODUCT_OPTION WHERE ONO = #{ono}),
			#{content},
			SYSDATE,
			#{contentimg}
		)
	</insert>
	
	<select id="reviewList" resultType="com.lee.myapp.domain.ReviewVO">
		SELECT A.RNO, A.PNO, A.MNO, (SELECT NAME FROM MEMBER WHERE MNO = B.MNO) AS NAME, A.ONO, A.OPTION_COLOR, A.OPTION_SIZE, A.CONTENT, A.WRITEDATE, A.CONTENT_IMG 
		  FROM TBL_PRODUCT_REVIEW A INNER JOIN MEMBER B ON A.MNO = B.MNO
		 WHERE A.PNO = #{pno}
		 ORDER BY A.WRITEDATE DESC
	</select>
	
	<select id="reviewListPaging" resultType="com.lee.myapp.domain.ReviewVO">
		<![CDATA[
		SELECT *
		  FROM(
		       SELECT ROWNUM AS RNUM, A.*
		         FROM(    
		              SELECT A.RNO, A.PNO, A.MNO, (SELECT NAME FROM MEMBER WHERE MNO = B.MNO) AS NAME, A.ONO, A.OPTION_COLOR, A.OPTION_SIZE, A.CONTENT, A.WRITEDATE, A.CONTENT_IMG 
		                FROM TBL_PRODUCT_REVIEW A INNER JOIN MEMBER B ON A.MNO = B.MNO
		               WHERE A.PNO = #{pno}
		               ORDER BY A.WRITEDATE DESC
		         ) A
		        WHERE ROWNUM <= #{rowEnd}
		      )
		 WHERE RNUM >= #{rowStart}
		 ]]>
	</select>
	
	<select id="reviewListCount" resultType="Integer">
		SELECT COUNT(*)
		  FROM TBL_PRODUCT_REVIEW
		 WHERE PNO = #{pno}
	</select>
	
	<select id="reviewLike" resultType="com.lee.myapp.domain.ReviewLikeVO">
		SELECT A.RNO, B.LIKE_CHECK
		  FROM TBL_PRODUCT_REVIEW A INNER JOIN TBL_PRODUCT_REVIEW_LIKE B ON A.RNO = B.RNO
		 WHERE A.PNO = #{pno} AND B.MNO = #{mno}
	</select>
	
	<select id="reviewLikeCount" resultType="com.lee.myapp.domain.ReviewLikeVO">
		SELECT B.RNO, COUNT(*) AS COUNT
		  FROM TBL_PRODUCT_REVIEW A INNER JOIN TBL_PRODUCT_REVIEW_LIKE B ON A.RNO = B.RNO
		 WHERE A.PNO = #{pno}
		 GROUP BY B.RNO
         ORDER BY B.RNO DESC
	</select>
	
	<update id="updateReviewStatus">
		 UPDATE TBL_ORDER
		    SET REVIEW_STATUS = 1
		  WHERE MNO = #{mno} AND ONO = (SELECT ONO FROM TBL_ORDER WHERE MNO = #{mno} AND ORDERNO = (SELECT ORDERNO FROM TBL_ORDER_DETAIL WHERE ONO = #{ono}))
	</update>
	
	<select id="checkLike" resultType="Integer">
		SELECT COUNT(*)
		  FROM TBL_PRODUCT_REVIEW_LIKE
		 WHERE MNO = #{mno} AND RNO = #{rno}
	</select>
	
	<insert id="registLike">
		INSERT INTO TBL_PRODUCT_REVIEW_LIKE VALUES(TBL_PRODUCT_REVIEW_LIKE_SEQ.NEXTVAL,#{rno},#{mno},1)
	</insert>
	
	<delete id="deleteLike">
		DELETE 
		  FROM TBL_PRODUCT_REVIEW_LIKE
		 WHERE MNO = #{mno} AND RNO = #{rno}
	</delete>
	
	<!-- Header banner -->
	<select id="mainBannerList" resultType="com.lee.myapp.domain.BannerVO">
		SELECT *
		  FROM TBl_BANNER
		 WHERE BANNER_STATUS = 1
		   AND AREA = #{area}
		 ORDER BY BNO DESC
	</select>
</mapper>